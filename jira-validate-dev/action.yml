name: Validate Jira ticket

inputs:
  runs-on:
    description: The type of machine to run the job on. The machine can be either a GitHub-hosted runner, or a self-hosted runner.
    required: false
    type: string
    default: ubuntu-latest
  CONTEXT_ENV:
    description: Dev or Test env
    required: true
    type: string
  JIRA_BASE_URL: 
    required: true
    type: string
  JIRA_USER_EMAIL:     
    required: true
    type: string
  JIRA_API_TOKEN:     
    required: true
    type: string

outputs:
  current_branch: 
    description: the current branch
    value: ${{ steps.branch-names.outputs.current_branch }}
  run_url: 
    description: the run url
    value: ${{ steps.set-run-url.outputs.url }}
  issue_url: 
    description: the issue url
    value: ${{ steps.validate-ticket.outputs.issue_url }}
  issue_summary: 
    description: the issue summary
    value: ${{ steps.validate-ticket.outputs.issue_summary }}

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v2
      with:
        python-version: '3.9'
    - name: Get branch names
      id: branch-names
      uses: tj-actions/branch-names@v5.2
    - name: Get run url
      id: set-run-url
      shell: bash
      run: |
        url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "RUN_URL=$url" >> $ $GITHUB_OUTPUT
    - name: Validate ticket
      id: validate-ticket
      shell: bash
      env:
        ISSUE_KEY: ${{ steps.branch-names.outputs.current_branch }}
        CONTEXT_ENV: ${{ inputs.CONTEXT_ENV }}
        JIRA_BASE_URL: ${{ inputs.JIRA_BASE_URL }}
        JIRA_USER_EMAIL: ${{ inputs.JIRA_USER_EMAIL }}
        JIRA_API_TOKEN: ${{ inputs.JIRA_API_TOKEN }}
      run: |
        pip install jira
        python ${{ github.action_path }}/jira_ticket_validation.py